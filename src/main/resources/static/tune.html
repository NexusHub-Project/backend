<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NexusHub AI Dataset Builder</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --blue: #1a237e; --red: #b71c1c; --text: #e0e0e0; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .match-card { background: var(--card); margin-bottom: 40px; border-radius: 12px; border: 1px solid #333; overflow: hidden; }
        .header { background: #333; padding: 12px 20px; display: flex; justify-content: space-between; font-weight: bold; }
        .teams-container { display: flex; }
        .team { flex: 1; padding: 20px; }
        .blue-team { background: rgba(26, 35, 126, 0.15); border-right: 1px solid #333; }
        .red-team { background: rgba(183, 28, 28, 0.15); }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .name { font-size: 0.9rem; font-weight: bold; }
        input { width: 70px; padding: 8px; background: #2a2a2a; border: 1px solid #555; color: #fff; text-align: center; border-radius: 6px; }
        .footer { position: sticky; bottom: 0; background: var(--bg); padding: 25px; text-align: center; border-top: 2px solid #333; z-index: 100; }
        button { padding: 18px 100px; background: #4caf50; color: white; border: none; border-radius: 40px; font-size: 1.2rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<h1 style="text-align: center;">ğŸ“Š AI í•™ìŠµìš© ë°ì´í„° ì±„ì  (Match-v5 êµ¬ì¡°)</h1>
<div id="status" style="text-align: center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
<div id="gameContainer"></div>

<div class="footer">
    <button onclick="generateCSV()">CSV ë°ì´í„°ì…‹ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ</button>
</div>

<script>
    const puuid = new URLSearchParams(window.location.search).get('puuid');
    let globalMatches = [];

    // 1. ë°ì´í„° ë¡œë“œ (List<MatchModelDto> ìˆ˜ì‹ )
    fetch(`/api/v1/tune/learning-data?puuid=${puuid}`)
        .then(res => res.json())
        .then(data => {
            globalMatches = data;
            document.getElementById('status').style.display = 'none';
            render(data);
        })
        .catch(err => {
            document.getElementById('status').innerHTML = `<h2 style="color:red;">ë¡œë“œ ì‹¤íŒ¨: ${err.message}</h2>`;
        });

    function render(matches) {
        const container = document.getElementById('matchContainer');
        // matchesëŠ” ë§¤ì¹˜ 20ê°œì˜ ë°°ì—´
        container.innerHTML = matches.map((match, gIdx) => {
            // ì œê³µí•´ì£¼ì‹  JSONì˜ 'info.participants' ë°°ì—´ ì ‘ê·¼
            const players = match.info.participants;

            return `
                    <div class="match-card">
                        <div class="header">
                            <span>GAME #${gIdx + 1}</span>
                            <span>Match ID: ${match.metadata.matchId}</span>
                        </div>
                        <div class="teams-container">
                            <div class="team blue-team">
                                <div style="color:#8ab4f8; font-weight:bold; margin-bottom:10px;">BLUE TEAM (1-5)</div>
                                ${renderPlayers(players.slice(0, 5), gIdx, 0)}
                            </div>
                            <div class="team red-team">
                                <div style="color:#f88a8a; font-weight:bold; margin-bottom:10px;">RED TEAM (6-10)</div>
                                ${renderPlayers(players.slice(5, 10), gIdx, 5)}
                            </div>
                        </div>
                    </div>
                `;
        }).join('');
    }

    function renderPlayers(players, gIdx, startIdx) {
        return players.map((p, pIdx) => `
                <div class="row">
                    <span class="name"><b>${startIdx + pIdx + 1}.</b> ${p.riotIdGameName} #${p.riotIdTagline}</span>
                    <input type="number"
                           class="score-input"
                           data-game="${gIdx}"
                           data-player="${startIdx + pIdx}"
                           placeholder="ì ìˆ˜" min="0" max="100">
                </div>
            `).join('');
    }

    // 2. CSV ìƒì„± (X: ì¸ê²Œì„ ì§€í‘œ + Challenges, Y: ì…ë ¥ ì ìˆ˜)
    function generateCSV() {
        if (globalMatches.length === 0) return;

        const csvRows = [];
        const scoreInputs = document.querySelectorAll('.score-input');
        const scoresMap = {};

        scoreInputs.forEach(input => {
            const key = `${input.dataset.game}_${input.dataset.player}`;
            scoresMap[key] = input.value || 0;
        });

        // í—¤ë” ìë™ ì¶”ì¶œ (ì²« ë²ˆì§¸ ê²Œì„ì˜ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ê¸°ì¤€)
        const samplePlayer = globalMatches[0].info.participants[0];
        const headers = [];

        // ì¼ë°˜ ì§€í‘œ í•„ë“œ ì¶”ì¶œ
        Object.keys(samplePlayer).forEach(k => {
            if (typeof samplePlayer[k] !== 'object') headers.push(k);
        });
        // Challenges ë‚´ë¶€ ì§€í‘œ í‰ë©´í™” (Flattening)
        if (samplePlayer.challenges) {
            Object.keys(samplePlayer.challenges).forEach(ck => headers.push("challenge_" + ck));
        }
        headers.push("performanceScore"); // ë§ˆì§€ë§‰ ì—´ ì •ë‹µ(Y)
        csvRows.push(headers.join(','));

        // ë°ì´í„° í–‰ ìƒì„± (20ê°œ ê²Œì„ x 10ëª… = 200ëª…)
        globalMatches.forEach((match, gIdx) => {
            match.info.participants.forEach((p, pIdx) => {
                const score = scoresMap[`${gIdx}_${pIdx}`];
                const row = headers.map(h => {
                    if (h === "performanceScore") return score;
                    if (h.startsWith("challenge_")) {
                        const cKey = h.replace("challenge_", "");
                        return p.challenges ? (p.challenges[cKey] ?? 0) : 0;
                    }
                    let val = p[h];
                    if (typeof val === 'string') return `"${val.replace(/"/g, '""')}"`;
                    return val ?? 0;
                });
                csvRows.push(row.join(','));
            });
        });

        // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ (BOM ì¶”ê°€ë¡œ í•œê¸€ ê¹¨ì§ ë°©ì§€)
        const blob = new Blob(["\ufeff" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `League_AI_Dataset_${new Date().getTime()}.csv`;
        link.click();
    }
</script>
<div id="matchContainer"></div>
</body>
</html>